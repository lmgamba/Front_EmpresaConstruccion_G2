<div class="dashboard-container">
  <main class="main-content">
    <header class="topbar">
      <h1>Admin Dashboard</h1>
      <div class="topbar-actions">
        <div class="profile">
          <div class="avatar">{{ currentUser()?.name?.[0] }}{{ currentUser()?.surname?.[0] }}</div>
          <span class="ms-2 text-white">{{ currentUser()?.name }}</span>
        </div>
      </div>
    </header>

    <section class="metrics">
      @for (metric of metrics(); track metric.title) {
        <div class="metric-card">
          <div class="metric-title">{{ metric.title }}</div>
          <div
            class="metric-value"
            [class.alert-value]="metric.title === 'Active Alerts' && metric.value !== '0'"
          >
            {{ metric.value }}
          </div>
          <div class="metric-sub">{{ metric.subtext }}</div>
        </div>
      }
    </section>

    <section class="content-grid">
      <div class="content-center">
        <div class="card map-card">
          <div class="card-header">
            <h3>Focus Site Location</h3>
          </div>
          <div class="map-placeholder p-0" style="min-height: 300px">
            @if (adminMapUrl()) {
              <iframe
                width="100%"
                height="300"
                style="border: 0; filter: grayscale(1) invert(0.92)"
                loading="lazy"
                [src]="adminMapUrl()"
              >
              </iframe>
            } @else {
              <div class="text-center p-5 text-secondary">No site coordinates available</div>
            }
          </div>
        </div>

        <div class="card projects-card">
          <div class="card-header">
            <h3>Active Projects Status</h3>
          </div>
          <table class="projects-table">
            <thead>
              <tr>
                <th>Project</th>
                <th>Address</th>
                <th>Workers</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              @for (project of projectsWithStats(); track project.id_constructions) {
                <tr>
                  <td>
                    <strong>{{ project.name }}</strong>
                  </td>
                  <td>{{ project.address }}</td>
                  <td>
                    <div class="progress-bar">
                      <div class="progress" [style.width.%]="project.completion"></div>
                    </div>
                    <span class="percent"> {{ project.workerCount }} Assigned </span>
                  </td>
                  <td>
                    <span class="status" [class]="project.status">{{ project.status }}</span>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>

      <div class="content-side">
        <div class="card workers">
          <div class="card-header">
            <h3>Staff Overview</h3>
          </div>
          <workers-list
            class="scroll-area container"
            style="max-height: 40vh; overflow-y: auto"
            [ArrayUsers]="allWorkers()"
          ></workers-list>
        </div>

        <div class="card feed-card">
          <div class="card-header">
            <h3>Site Reports</h3>
            @if (allLogs().length > 0) {
              <span class="badge">Current Site</span>
            }
          </div>
          <div class="feed-list">
            @for (item of feed(); track item.id) {
              <div class="feed-item" [class.alert-border]="item.type === 'ALERT'">
                <div class="feed-header d-flex justify-content-between align-items-center">
                  <span class="badge" [ngClass]="item.type === 'ALERT' ? 'bg-danger' : 'bg-info'">
                    {{ item.type }}
                  </span>
                  <span class="feed-time small text-secondary">Recently</span>
                </div>
                <div class="feed-message text-white mt-2">
                  {{ item.message }}
                </div>
              </div>
            } @empty {
              <div class="p-4 text-center">
                <i class="bi bi-journal-x fs-2 text-secondary"></i>
                <p class="text-secondary mt-2">No reports found for your assigned site.</p>
              </div>
            }
          </div>
        </div>
      </div>
    </section>
  </main>
</div>
